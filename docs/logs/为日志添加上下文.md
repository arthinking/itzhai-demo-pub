# 为日志添加上下文

## 使用SpringBoot实现的最小可用方案

### 1. 在请求入口填充上下文：

```java
@Component
public class LoggingContextFilter implements Filter {

    @Override
    public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain)
            throws IOException, ServletException {
        HttpServletRequest r = (HttpServletRequest) req;

        String traceId = Optional.ofNullable(r.getHeader("X-Trace-Id"))
                                 .orElse(UUID.randomUUID().toString());
        String userId = Optional.ofNullable(r.getHeader("X-User-Id")).orElse("anonymous");
        String clientIp = Optional.ofNullable(r.getHeader("X-Forwarded-For"))
                                  .orElse(r.getRemoteAddr());

        MDC.put("traceId", traceId);
        MDC.put("userId", userId);
        MDC.put("clientIp", clientIp);

        try {
            chain.doFilter(req, res);
        } finally {
            MDC.clear(); 
        }
    }
}

```

这样，你在代码里面任何地方执行log.info，都会自动带上这些字段了。

### 2. 让日志系统固定携带这些字段

加logstash依赖：

```xml
<dependency>
  <groupId>net.logstash.logback</groupId>
  <artifactId>logstash-logback-encoder</artifactId>
  <version>7.4</version>
</dependency>
```

logback-spring.xml 核心配置：

```java
<configuration>
  <appender name="JSON" class="ch.qos.logback.core.ConsoleAppender">
    <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
      <providers>
        <timestamp />
        <pattern>
          <pattern>
            {
              "level": "%level",
              "logger": "%logger{36}",
              "thread": "%thread",
              "message": "%msg",
              "app": "order-service",
              "env": "prod"
            }
          </pattern>
        </pattern>
        <!-- 把 MDC 全量写入 -->
        <mdc />
        <stackTrace />
      </providers>
    </encoder>
  </appender>

  <root level="INFO">
    <appender-ref ref="JSON"/>
  </root>
</configuration>

```

这样每条日志都会自动携带：

```java
{
	"@timestamp": "2025-08-09T15:17:28.568126+08:00",
	"level": "INFO",
	"logger_name": "com.itzhai.demo.pub.logger.controller.LogTestController",
	"thread_name": "http-nio-8080-exec-1",
	"message": "Get current server time",
	"traceId": "ee3c8064-9a9a-434a-b7a3-4dacb78137ff",
	"userId": "anonymous",
	"clientIp": "0:0:0:0:0:0:0:1"
}
```

控制台的打印格式如下：

```
2025-08-09 15:17:28,568 INFO  [http-nio-8080-exec-1] c.i.d.p.l.c.LogTestController - Get current server time | traceId=ee3c8064-9a9a-434a-b7a3-4dacb78137ff userId=anonymous clientIp=0:0:0:0:0:0:0:1
```

Filebeat/Fluent Bit 只需要采集这个JSON日志，就可以把携带了MDC的日志同步到日志平台了。



